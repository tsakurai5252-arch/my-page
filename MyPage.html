<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>マイページ - 会員ポータル</title>
<style>
  :root { --primary: #007bff; --gold: #d4af37; --platinum: #374151; --silver: #a0a0a0; --base: #666666; }
  body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
  .card { background: white; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; overflow: hidden; animation: fadeIn 0.6s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  .header { background: #fff; padding: 30px 20px 10px; text-align: center; }
  .login-section { padding: 20px; }
  input { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; transition: 0.3s; box-sizing: border-box; }
  input:focus { border-color: var(--primary); outline: none; }
  .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
  .btn:hover { opacity: 0.9; transform: scale(0.98); }

  /* 認証後の表示エリア */
  .result-area { display: none; padding-bottom: 30px; }
  .rank-section { text-align: center; padding: 10px 0; }
  .rank-badge { display: inline-block; padding: 6px 20px; border-radius: 50px; color: white; font-size: 14px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
  
  /* ポイント表示のリッチ化 */
  .point-container { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); margin: 0 25px 20px; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
  .point-label { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
  .point-value { font-size: 48px; font-weight: 800; color: #333; line-height: 1; }
  .point-unit { font-size: 16px; margin-left: 5px; color: #555; }

  .user-info { padding: 0 30px; }
  .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; color: #555; font-size: 14px; }
  .info-row strong { color: #222; }
  .msg-box { margin: 20px 25px 0; padding: 15px; background: #fff9db; border-left: 4px solid #fab005; border-radius: 8px; font-size: 13px; color: #665c33; }
</style>
</head>
<body>

<div class="card">
  <div class="header" id="cardHeader">
    <h2 id="titleLabel">マイページ</h2>
  </div>

  <div class="login-section" id="loginForm">
    <input type="text" id="memberId" placeholder="会員番号 (ID)">
    <input type="text" id="memberName" placeholder="お名前 (フルネーム)">
    <button class="btn" onclick="login()">ログイン</button>
  </div>

  <div id="resultArea" class="result-area">
    <div class="rank-section">
      <div id="resRank" class="rank-badge">---</div>
    </div>

    <div class="point-container">
      <div class="point-label">ポイント残高</div>
      <div class="point-value"><span id="resPoints">0</span><span class="point-unit">pt</span></div>
    </div>

    <div class="user-info">
      <div class="info-row"><span>名前</span><strong id="resName">---</strong></div>
      <div class="info-row"><span>有効期限</span><strong id="resExp">---</strong></div>
      <div class="info-row"><span>更新回数</span><strong id="resCount">0</strong></div>
    </div>

    <div id="resMessage" class="msg-box"></div>
    <div style="padding:25px;"><button class="btn" style="background:#666;" onclick="location.reload()">ログアウト</button></div>
  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxy_csm6SjeGboSzae4wOfNgHBzHGh_ZC2u2ciGc678YhcMRe1A5Zio-upZDzJLFKZn/exec"; // ★デプロイ後の新URLに書き換え
const SECRET_SALT = "BLUE_SKY_77";

async function generateSecureKey(id) {
  const dateRes = await fetch(`${WEBAPP_URL}?mode=getServerTime`);
  const serverDate = await dateRes.text();
  return (id + serverDate + SECRET_SALT).split("").reverse().join("");
}

async function login() {
  const id = document.getElementById("memberId").value.trim();
  const name = document.getElementById("memberName").value.trim();
  if(!id || !name) return alert("IDと名前を入力してください");

  try {
    const vKey = await generateSecureKey(id);
    const url = `${WEBAPP_URL}?mode=mypage&id=${id}&name=${encodeURIComponent(name)}&_v=${vKey}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.result === "success") {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("titleLabel").textContent = "会員情報";
      document.getElementById("resultArea").style.display = "block";
      
      document.getElementById("resName").textContent = data.info.name;
      document.getElementById("resExp").textContent = data.info.exp;
      document.getElementById("resPoints").textContent = data.info.points.toLocaleString();
      document.getElementById("resCount").textContent = data.info.count + "回";
      document.getElementById("resMessage").textContent = data.info.message || "運営からのお知らせはありません。";
      
      const rb = document.getElementById("resRank");
      rb.textContent = data.info.rank + " 会員";
      rb.style.background = data.info.rankColor;
    } else {
      alert(data.message);
    }
  } catch (e) { alert("通信エラーが発生しました"); }
}
</script>
<div class="footer-copyright">
  <?!= copyrightText ?>
</div>
</body>

</html>
